<%- include('partials/header', { page: 'shop', categories: typeof categories !== 'undefined' ? categories : [] }) %>

    <!-- Single Page Header start -->
    <div class="container-fluid page-header py-5">
        <h1 class="text-center text-white display-6 wow fadeInUp" data-wow-delay="0.1s">Shop</h1>
        <ol class="breadcrumb justify-content-center mb-0 wow fadeInUp" data-wow-delay="0.3s">
            <li class="breadcrumb-item"><a href="/">Home</a></li>
            <li class="breadcrumb-item active text-white">Shop</li>
        </ol>
    </div>
    <!-- Single Page Header End -->

    <!-- Shop Start -->
    <div class="container-fluid py-5">
        <div class="container py-5">
            <div class="row g-4">
                <!-- Sidebar -->
                <div class="col-lg-3">
                    <div class="border rounded p-4 mb-4">
                        <h4 class="mb-4">Categories</h4>
                        <ul class="list-unstyled">
                            <li>
                                <label class="d-flex align-items-center py-2 cursor-pointer" style="cursor: pointer;">
                                    <input type="radio" name="category" class="form-check-input me-2" <%= !categoryId ? 'checked' : '' %> onchange="filterProducts(null, <%= priceMin || 'null' %>, <%= priceMax || 'null' %>, null)">
                                    <span class="text-dark <%= !categoryId ? 'fw-bold' : '' %>">All Categories</span>
                                </label>
                            </li>
                            <% if (typeof categories !== 'undefined') { %>
                                <% categories.forEach(category => { %>
                                    <li>
                                        <label class="d-flex align-items-center py-2 cursor-pointer" style="cursor: pointer;">
                                            <input type="radio" name="category" class="form-check-input me-2" <%= categoryId && categoryId === category._id.toString() ? 'checked' : '' %> onchange="filterProducts('<%= category._id %>', <%= priceMin || 'null' %>, <%= priceMax || 'null' %>, null)">
                                            <span class="text-dark <%= categoryId && categoryId === category._id.toString() ? 'fw-bold' : '' %>"><%= category.name %></span>
                                        </label>
                                    </li>
                                <% }); %>
                            <% } %>
                        </ul>
                    </div>
                    
                    <div class="border rounded p-4 mb-4">
                        <h4 class="mb-4">Lọc theo giá</h4>
                        <ul class="list-unstyled">
                            <li>
                                <label class="d-flex align-items-center py-2 cursor-pointer" style="cursor: pointer;">
                                    <input type="radio" name="price" class="form-check-input me-2" <%= !priceMin && !priceMax ? 'checked' : '' %> onchange="filterProducts(<%= categoryId ? '\'' + categoryId + '\'' : 'null' %>, null, null, null)">
                                    <span class="text-dark <%= !priceMin && !priceMax ? 'fw-bold' : '' %>">Tất cả giá</span>
                                </label>
                            </li>
                            <li>
                                <label class="d-flex align-items-center py-2 cursor-pointer" style="cursor: pointer;">
                                    <input type="radio" name="price" class="form-check-input me-2" <%= parseInt(priceMin) === 0 && parseInt(priceMax) === 1000000 ? 'checked' : '' %> onchange="filterProducts(<%= categoryId ? '\'' + categoryId + '\'' : 'null' %>, 0, 1000000, null)">
                                    <span class="text-dark <%= parseInt(priceMin) === 0 && parseInt(priceMax) === 1000000 ? 'fw-bold' : '' %>">Dưới 1.000.000 VNĐ</span>
                                </label>
                            </li>
                            <li>
                                <label class="d-flex align-items-center py-2 cursor-pointer" style="cursor: pointer;">
                                    <input type="radio" name="price" class="form-check-input me-2" <%= parseInt(priceMin) === 1000000 && parseInt(priceMax) === 5000000 ? 'checked' : '' %> onchange="filterProducts(<%= categoryId ? '\'' + categoryId + '\'' : 'null' %>, 1000000, 5000000, null)">
                                    <span class="text-dark <%= parseInt(priceMin) === 1000000 && parseInt(priceMax) === 5000000 ? 'fw-bold' : '' %>">1.000.000 - 5.000.000 VNĐ</span>
                                </label>
                            </li>
                            <li>
                                <label class="d-flex align-items-center py-2 cursor-pointer" style="cursor: pointer;">
                                    <input type="radio" name="price" class="form-check-input me-2" <%= parseInt(priceMin) === 5000000 && parseInt(priceMax) === 10000000 ? 'checked' : '' %> onchange="filterProducts(<%= categoryId ? '\'' + categoryId + '\'' : 'null' %>, 5000000, 10000000, null)">
                                    <span class="text-dark <%= parseInt(priceMin) === 5000000 && parseInt(priceMax) === 10000000 ? 'fw-bold' : '' %>">5.000.000 - 10.000.000 VNĐ</span>
                                </label>
                            </li>
                            <li>
                                <label class="d-flex align-items-center py-2 cursor-pointer" style="cursor: pointer;">
                                    <input type="radio" name="price" class="form-check-input me-2" <%= parseInt(priceMin) === 10000000 && parseInt(priceMax) === 20000000 ? 'checked' : '' %> onchange="filterProducts(<%= categoryId ? '\'' + categoryId + '\'' : 'null' %>, 10000000, 20000000, null)">
                                    <span class="text-dark <%= parseInt(priceMin) === 10000000 && parseInt(priceMax) === 20000000 ? 'fw-bold' : '' %>">10.000.000 - 20.000.000 VNĐ</span>
                                </label>
                            </li>
                            <li>
                                <label class="d-flex align-items-center py-2 cursor-pointer" style="cursor: pointer;">
                                    <input type="radio" name="price" class="form-check-input me-2" <%= parseInt(priceMin) === 20000000 && !priceMax ? 'checked' : '' %> onchange="filterProducts(<%= categoryId ? '\'' + categoryId + '\'' : 'null' %>, 20000000, null, null)">
                                    <span class="text-dark <%= parseInt(priceMin) === 20000000 && !priceMax ? 'fw-bold' : '' %>">Trên 20.000.000 VNĐ</span>
                                </label>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Products -->
                <div class="col-lg-9" id="products-section">
                    <%- include('partials/shop-products', { products, currentPage, totalPages, categoryId, search, priceMin, priceMax, user: typeof user !== 'undefined' ? user : null }) %>
                </div>
            </div>
        </div>
    </div>
    <!-- Shop End -->

<script>
function addToCart(productId) {
    fetch('/api/cart/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ product_id: productId, quantity: 1 })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Added to cart!');
            // Update cart icon with new count and total
            if (data.data && window.updateCartIcon) {
                window.updateCartIcon(data.data.cartCount, data.data.cartTotal);
            }
        }
    });
}

function loadProducts(page, categoryId, search, priceMin, priceMax) {
    const params = new URLSearchParams();
    if (page) params.append('page', page);
    if (categoryId) params.append('category', categoryId);
    if (search) params.append('search', search);
    if (priceMin !== null && priceMin !== undefined) params.append('priceMin', priceMin);
    if (priceMax !== null && priceMax !== undefined) params.append('priceMax', priceMax);
    
    const url = '/shop?' + params.toString();
    
    // Update URL without reload
    window.history.pushState({}, '', url);
    
    // Show loading
    document.getElementById('products-section').innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
    
    fetch(url, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.text())
    .then(html => {
        document.getElementById('products-section').innerHTML = html;
        // Scroll to top smoothly
        window.scrollTo({ top: 0, behavior: 'smooth' });
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('products-section').innerHTML = '<div class="alert alert-danger">Có lỗi xảy ra khi tải sản phẩm</div>';
    });
}

function filterProducts(categoryId, priceMin, priceMax, search) {
    loadProducts(1, categoryId, search, priceMin, priceMax);
}

// Handle browser back/forward buttons
window.addEventListener('popstate', function(event) {
    const urlParams = new URLSearchParams(window.location.search);
    const page = urlParams.get('page') || 1;
    const categoryId = urlParams.get('category') || null;
    const search = urlParams.get('search') || null;
    const priceMin = urlParams.get('priceMin') ? parseInt(urlParams.get('priceMin')) : null;
    const priceMax = urlParams.get('priceMax') ? parseInt(urlParams.get('priceMax')) : null;
    
    loadProducts(page, categoryId, search, priceMin, priceMax);
});
</script>

<%- include('partials/footer') %>

