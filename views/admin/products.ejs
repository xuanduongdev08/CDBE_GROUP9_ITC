<%- include('../partials/admin-header', { page: 'products', title: 'Quản Lý Sản Phẩm', user: typeof user !== 'undefined' ? user : null }) %>

                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3 class="mb-0"></h3>
                        <a href="/admin/products/new" class="btn btn-primary rounded-pill">
                            <i class="fas fa-plus me-2"></i>Thêm Sản Phẩm
                        </a>
                    </div>

                    <div class="card admin-card wow fadeInUp" data-wow-delay="0.1s">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-box me-2 text-primary"></i>Danh Sách Sản Phẩm
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Hình Ảnh</th>
                                            <th>Tên Sản Phẩm</th>
                                            <th>Danh Mục</th>
                                            <th>Giá</th>
                                            <th>Tồn Kho</th>
                                            <th>Thao Tác</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% if (typeof products !== 'undefined' && products.length > 0) { %>
                                            <% products.forEach(product => { %>
                                                <tr>
                                                    <td>
                                                        <% 
                                                            let imageUrl = product.image_url || '/img/product-3.png';
                                                            // Nếu image_url không bắt đầu bằng / thì thêm /
                                                            if (imageUrl && !imageUrl.startsWith('/') && !imageUrl.startsWith('http')) {
                                                                imageUrl = '/' + imageUrl;
                                                            }
                                                        %>
                                                        <img src="<%= imageUrl %>" 
                                                             alt="<%= product.name %>" 
                                                             class="rounded"
                                                             style="width: 60px; height: 60px; object-fit: cover;"
                                                             onerror="this.src='/img/product-3.png'; this.onerror=null;">
                                                    </td>
                                                    <td><strong><%= product.name %></strong></td>
                                                    <td>
                                                        <span class="badge bg-info rounded-pill">
                                                            <%= product.category_id ? product.category_id.name : 'Chưa phân loại' %>
                                                        </span>
                                                    </td>
                                                    <td><strong class="text-primary"><%= new Intl.NumberFormat('vi-VN').format(product.price) %> VNĐ</strong></td>
                                                    <td>
                                                        <span class="badge bg-<%= product.stock > 0 ? 'success' : 'danger' %> rounded-pill">
                                                            <%= product.stock || 0 %>
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <div class="d-flex gap-2 align-items-center" style="flex-wrap: nowrap;">
                                                            <a href="/admin/products/<%= product._id %>" class="btn btn-sm btn-primary rounded-pill" style="white-space: nowrap;">
                                                                <i class="fas fa-eye me-1"></i>Xem
                                                            </a>
                                                            <a href="/admin/products/<%= product._id %>/edit" class="btn btn-sm btn-warning rounded-pill" style="white-space: nowrap;">
                                                                <i class="fas fa-edit me-1"></i>Sửa
                                                            </a>
                                                            <button onclick="deleteProduct('<%= product._id %>')" class="btn btn-sm btn-danger rounded-pill" style="white-space: nowrap;">
                                                                <i class="fas fa-trash me-1"></i>Xóa
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            <% }); %>
                                        <% } else { %>
                                            <tr>
                                                <td colspan="6" class="text-center py-5">
                                                    <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                                                    <p class="text-muted">Chưa có sản phẩm nào</p>
                                                    <a href="/admin/products/new" class="btn btn-primary rounded-pill">
                                                        <i class="fas fa-plus me-2"></i>Thêm Sản Phẩm Đầu Tiên
                                                    </a>
                                                </td>
                                            </tr>
                                        <% } %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

<%- include('../partials/admin-footer') %>

<script>
    function deleteProduct(id) {
        if (confirm('Bạn có chắc chắn muốn xóa sản phẩm này?')) {
            fetch(`/admin/products/${id}`, {
                method: 'DELETE'
            })
            .then(() => location.reload());
        }
    }
</script>
