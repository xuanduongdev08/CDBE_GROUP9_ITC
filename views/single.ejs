<%- include('partials/header', { page: 'single' , categories: typeof categories !=='undefined' ? categories : [] }) %>

    <!-- Single Page Header start -->
    <div class="container-fluid page-header py-5">
        <h1 class="text-center text-white display-6 wow fadeInUp" data-wow-delay="0.1s">Product Details</h1>
        <ol class="breadcrumb justify-content-center mb-0 wow fadeInUp" data-wow-delay="0.3s">
            <li class="breadcrumb-item"><a href="/">Home</a></li>
            <li class="breadcrumb-item"><a href="/shop">Shop</a></li>
            <li class="breadcrumb-item active text-white">Product</li>
        </ol>
    </div>
    <!-- Single Page Header End -->

    <!-- Product Details Start -->
    <div class="container-fluid py-5">
        <div class="container py-5">
            <% if (typeof product !=='undefined' ) { %>
                <div class="row g-4">
                    <div class="col-lg-6">
                        <img src="<%= product.image_url || '/img/product-3.png' %>" class="img-fluid w-100"
                            alt="<%= product.name %>">
                    </div>
                    <div class="col-lg-6">
                        <h2 class="mb-4">
                            <%= product.name %>
                        </h2>
                        <p class="text-primary fs-3 mb-4">
                            <%= new Intl.NumberFormat('vi-VN').format(product.price) %> VNĐ
                        </p>
                        <p class="mb-4">
                            <%= product.description || 'No description available' %>
                        </p>
                        <div class="mb-4">
                            <strong>Category:</strong>
                            <a href="/shop?category=<%= product.category_id ? product.category_id._id : '' %>">
                                <%= product.category_id ? product.category_id.name : 'Uncategorized' %>
                            </a>
                        </div>
                        <% if (typeof user !=='undefined' && user) { %>
                            <% if (product.stock> 0) { %>
                                <div class="mb-4">
                                    <strong class="d-block mb-2">Số lượng:</strong>
                                    <div class="d-flex align-items-center">
                                        <button onclick="decreaseQuantity()"
                                            class="btn btn-outline-primary rounded-circle"
                                            style="width: 40px; height: 40px;">
                                            <i class="fas fa-minus"></i>
                                        </button>
                                        <input type="number" id="quantity" value="1" min="1"
                                            max="<%= product.stock || 999 %>" class="form-control text-center mx-3"
                                            style="width: 80px;" readonly>
                                        <button onclick="increaseQuantity()"
                                            class="btn btn-outline-primary rounded-circle"
                                            style="width: 40px; height: 40px;">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                                <button onclick="addToCart('<%= product._id %>')"
                                    class="btn btn-primary rounded-pill py-3 px-5">
                                    <i class="fas fa-shopping-cart me-2"></i> Add To Cart
                                </button>
                                <% } else { %>
                                    <div class="alert alert-danger d-flex align-items-center mb-4" role="alert">
                                        <i class="fas fa-ban me-3 fs-4"></i>
                                        <div>
                                            <strong>Đã hết hàng</strong><br>
                                            <small>Sản phẩm này hiện tại không còn hàng trong kho.</small>
                                        </div>
                                    </div>
                                    <button class="btn btn-secondary rounded-pill py-3 px-5" disabled>
                                        <i class="fas fa-ban me-2"></i> Đã hết hàng
                                    </button>
                                    <% } %>
                                        <% } else { %>
                                            <a href="/auth/login" class="btn btn-primary rounded-pill py-3 px-5">
                                                <i class="fas fa-shopping-cart me-2"></i> Add To Cart
                                            </a>
                                            <% } %>
                    </div>
                </div>

                <% if (typeof relatedProducts !=='undefined' && relatedProducts.length> 0) { %>
                    <div class="row g-4 mt-5">
                        <div class="col-12">
                            <h3 class="mb-4">Related Products</h3>
                        </div>
                        <% relatedProducts.forEach(relatedProduct=> { %>
                            <div class="col-md-6 col-lg-3">
                                <div class="product-item rounded">
                                    <div class="product-item-inner border rounded">
                                        <div class="product-item-inner-item">
                                            <img src="<%= relatedProduct.image_url || '/img/product-3.png' %>"
                                                class="img-fluid w-100 rounded-top" alt="<%= relatedProduct.name %>">
                                            <div class="product-details">
                                                <a href="/single/<%= relatedProduct._id %>"><i
                                                        class="fa fa-eye fa-1x"></i></a>
                                            </div>
                                        </div>
                                        <div class="text-center rounded-bottom p-4">
                                            <a href="/single/<%= relatedProduct._id %>" class="d-block h5">
                                                <%= relatedProduct.name %>
                                            </a>
                                            <span class="text-primary fs-5">
                                                <%= new Intl.NumberFormat('vi-VN').format(relatedProduct.price) %> VNĐ
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <% }); %>
                    </div>
                    <% } %>
                        <% } else { %>
                            <div class="text-center">
                                <p>Product not found</p>
                                <a href="/shop" class="btn btn-primary">Back to Shop</a>
                            </div>
                            <% } %>
        </div>
    </div>
    <!-- Product Details End -->

    <script>
        function increaseQuantity() {
            const quantityInput = document.getElementById('quantity');
            const currentValue = parseInt(quantityInput.value);
            const maxValue = parseInt(quantityInput.max);

            if (currentValue < maxValue) {
                quantityInput.value = currentValue + 1;
            }
        }

        function decreaseQuantity() {
            const quantityInput = document.getElementById('quantity');
            const currentValue = parseInt(quantityInput.value);
            const minValue = parseInt(quantityInput.min);

            if (currentValue > minValue) {
                quantityInput.value = currentValue - 1;
            }
        }

        function addToCart(productId) {
            const quantityInput = document.getElementById('quantity');
            const quantity = quantityInput ? parseInt(quantityInput.value) : 1;

            fetch('/api/cart/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ product_id: productId, quantity: quantity })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Đã thêm ' + quantity + ' sản phẩm vào giỏ hàng!');
                        // Update cart icon with new count and total
                        if (data.data && window.updateCartIcon) {
                            window.updateCartIcon(data.data.cartCount, data.data.cartTotal);
                        }
                        // Reset quantity to 1 after adding to cart
                        if (quantityInput) {
                            quantityInput.value = 1;
                        }
                    } else {
                        alert('Có lỗi xảy ra: ' + (data.error || 'Không thể thêm vào giỏ hàng'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Có lỗi xảy ra khi thêm vào giỏ hàng');
                });
        }
    </script>

    <%- include('partials/footer') %>